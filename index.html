<!DOCTYPE html>
<html>
<head>
	<title>Coordinates Generator</title>
	<link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
	<link rel="stylesheet" type="text/css" href="css/bootstrap-theme.min.css">
	<link href="clusterize/clusterize.css" rel="stylesheet">
	<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximun-scale=1.0, minimun-scale=1.0">
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<script src="js/jquery.min.js"></script>
	<script src="js/bootstrap.min.js"></script>
	<script src="js/jquery.timer.js"></script>
	<script src="clusterize/clusterize.min.js"></script>
	<script src="https://maps.googleapis.com/maps/api/js?v=3&key=AIzaSyAHd6KyYBd0Ux6e7ureks9uHpANNhDBfP4&libraries=drawing"></script>
	<script>
    var map;
    var drawingManager;
    var coordinates = [];
    var shape = null;
    var south,north,east,west;
    var southToNorth,westToEast,currentPosition;
    var positionsGenerated;

	function initMap() {
		map = new google.maps.Map(document.getElementById('map'), {
			center: {lat: -34.397, lng: 150.644},
			zoom: 16
		});

		drawingManager = new google.maps.drawing.DrawingManager({
			drawingMode: google.maps.drawing.OverlayType.MARKER,
			drawingControl: true,
			drawingControlOptions: {
			  position: google.maps.ControlPosition.TOP_CENTER,
			  drawingModes: [
			    //google.maps.drawing.OverlayType.CIRCLE,
			    //google.maps.drawing.OverlayType.POLYGON,
			    google.maps.drawing.OverlayType.RECTANGLE
			  ]
			}
		});

		drawingManager.setMap(map);

		google.maps.event.addListener(drawingManager, 'circlecomplete', function(circle) {
			createShape(circle,'C');
		});

		google.maps.event.addListener(drawingManager, 'rectanglecomplete', function(event) {
			createShape(event,'R');
			//generateCoordinates();
		});


		google.maps.event.addListener(drawingManager, 'polygoncomplete', function(event) {
			createShape(event,'P');
			//generateCoordinates(event);
		});

	}

	function cleanShape()
	{
		shape.setMap(null);
		positionsGenerated.setMap(null);

	}

	function createShape(data,type)
	{
		
		if(shape != null)
		{
			cleanShape();
		}
		
		var coords = [];
		
		north = data.bounds.getNorthEast().lat();
		east = data.bounds.getNorthEast().lng();
		south = data.bounds.getSouthWest().lat();
		west = data.bounds.getSouthWest().lng();


		shape = new google.maps.Rectangle({
		bounds: {
			north: north,
			south: south,
			east: east,
			west: west
		}
		});
		
	}

	function getLatLngFromString(lat,lng) {
		return new google.maps.LatLng(parseFloat(lat), parseFloat(lng));
	}

	function getInitialPosition()
	{
		if($('#southToNorthS').is(':checked'))
		{
			southToNorth = 's';
		}
		else
		{
			southToNorth = 'n';
		}

		if($('#westToEastW').is(':checked'))
		{
			westToEast = 'w';
		}
		else
		{
			westToEast = 'e';
		}

		if(southToNorth == 's' && westToEast == 'w')
		{
			currentPosition = getLatLngFromString(south,west);
		}

		if(southToNorth == 's' && westToEast == 'e')
		{
			currentPosition = getLatLngFromString(south,east);
		}

		if(southToNorth == 'n' && westToEast == 'w')
		{
			currentPosition = getLatLngFromString(north,west);
		}

		if(southToNorth == 'n' && westToEast == 'e')
		{
			currentPosition = getLatLngFromString(north,east);
		}

		return currentPosition;
	}

	function getDistanceSouthToNorth()
	{
		var cantOfPointsSTN = 5;
		var totalDistance = Math.abs(north - south);
		var result = totalDistance / 5;
		if(result.toString().length > 7)
			result = parseFloat(result.toString().substring(0,7));

		return result;
	}

	function generateCoordinates()
	{
		var distanceSTN = getDistanceSouthToNorth();
		var exit = false;
		var countNotFound = 0;
		var currentLat,currentLng,nextLat,nextLng;
		var currentPosition = getInitialPosition();
		do
		{
			if(shape.getBounds().contains(currentPosition))
			{
				coordinates.push(currentPosition);

				if(countNotFound > 0)
				{
					countNotFound = 0;
					southToNorth = (southToNorth == 's') ? 'n' : 's';
				}

				if(southToNorth == 's')
				{
					currentLat = currentPosition.lat();
					currentLng = currentPosition.lng();

					nextLat = currentLat + distanceSTN;
					nextLng = currentLng;
				}
				else
				{
					currentLat = currentPosition.lat();
					currentLng = currentPosition.lng();

					nextLat = currentLat - distanceSTN;
					nextLng = currentLng;	
				}
				currentPosition = getLatLngFromString(nextLat,nextLng);
			}
			else
			{
				countNotFound++;
				if(countNotFound < 2)
				{
					if(westToEast == 'e')
					{
						currentLat = currentPosition.lat();
						currentLng = currentPosition.lng();

						if(currentLat <= north && currentLat >= south)
						{
							nextLat = currentLat;							
						}
						else
						{
							if(southToNorth == 's')
							{
								nextLat = currentLat - distanceSTN;
							}
							else
							{
								nextLat = currentLat + distanceSTN;	
							}
						}

						nextLng = currentLng - 0.0001;
					}
					else
					{
						currentLat = currentPosition.lat();
						currentLng = currentPosition.lng();

						if(currentLat <= north && currentLat >= south)
						{
							nextLat = currentLat;							
						}
						else
						{
							if(southToNorth == 's')
							{
								nextLat = currentLat - distanceSTN;
							}
							else
							{
								nextLat = currentLat + distanceSTN;	
							}
						}

						nextLng = currentLng + 0.0001;
					}
					currentPosition = getLatLngFromString(nextLat,nextLng);
				}
				else
				{
					exit = true;
				}
			}
		}while(!exit);

		chooseDrawType();
		
	}

	function drawPath()
	{

		var initialPosition = 0;
		var cantOfPoints = 25;
		var noMorePositions = false;
		var timer = $.timer(function(){
			
			var newCoordinates = [];

			for(var i = initialPosition; i <= (initialPosition + cantOfPoints);i++)
			{
				newCoordinates.push(coordinates[i]);
				if(i == (coordinates.length -1))
				{
					noMorePositions = true;
					break;
				}
			}

			if((initialPosition + cantOfPoints) < coordinates.length)
			{
				initialPosition += cantOfPoints;
			}
			else
			{
				initialPosition = initialPosition + (coordinates.length - initialPosition);
			}
			

			positionsGenerated = new google.maps.Polyline({
				path: newCoordinates,
				geodesic: true,
				strokeColor: '#FF0000',
				strokeOpacity: 1.0,
				strokeWeight: 2
			});

			positionsGenerated.setMap(map);

			if(noMorePositions)
			{
				timer.stop();
			}

		},500,true);
		

		
	}

	function showCoordinatesWrap()
	{
		var valText = '';
		for(var i=0;i<coordinates.length;i++)
		{
			valText += coordinates[i].lat() +','+coordinates[i].lng() + ';';
		}
		$('#resultCoordinates').val(valText);
	}

	function showCoordinates()
	{
		var data = [];

		var valText = '';
		for(var i=0;i<coordinates.length;i++)
		{
			var currentData = '<li>'+coordinates[i].lat() +','+coordinates[i].lng() + '</li>';
			data.push(currentData);
			//valText += coordinates[i].lat() +','+coordinates[i].lng() + '\n';
		}
		//$('#resultCoordinates').val(valText);
		var clusterize = new Clusterize({
			rows: data,
			scrollId: 'scrollArea',
			contentId: 'contentArea'
		});
	}

	function chooseDrawType()
	{
		drawPath();
		if($('#wrapCheck').is(':checked'))
		{
			showCoordinatesWrap();
		}
		else
		{
			showCoordinates();
		}
	}

	function locateMe()
	{

		var infoWindow = new google.maps.InfoWindow({map: map});

		if (navigator.geolocation) {
			navigator.geolocation.getCurrentPosition(function(position) {
				var pos = {
				lat: position.coords.latitude,
				lng: position.coords.longitude
				};

		//infoWindow.setPosition(pos);
		//infoWindow.setContent('Location found.');
				map.setCenter(pos);
			}, function() {
				handleLocationError(true, infoWindow, map.getCenter());
			});
		}
		else
		{
		// Browser doesn't support Geolocation
		handleLocationError(false, infoWindow, map.getCenter());
		}
	}

	function handleLocationError(browserHasGeolocation, infoWindow, pos) 
	{
		infoWindow.setPosition(pos);
		infoWindow.setContent(browserHasGeolocation ? 'Error: The Geolocation service failed.' : 'Error: Your browser doesn\'t support geolocation.');
	}
	

	$(document).ready(function(){
		initMap();
	})
	</script>
</head>
<body>
	<div class="container">
		<div class="row">
			<h1>Coordinate Generator</h1>
		</div>
		<div class="row col-xs-8" align="center">
			<button type="button" class="btn btn-success" onClick="locateMe();">Locate Me!</button>
		</div>
		<div class="row">
			<div class="col-xs-8" style="height:400px">
				<div id="map" style="height:100%">
					
				</div>
			</div>
			<div class="col-xs-4">
				<div class="form-group">
					<div class="col-sm-12 bg-info" align="center">
						<div class="checkbox">
							<label>
							<input id="wrapCheck" type="checkbox" onclick="chooseDrawType();"> Wrap
							</label>
						</div>
					</div>
					<div id="scrollArea" class="col-sm-12 clusterize-scroll" style="width:100%;">
						<ul id="contentArea" class="clusterize-content" style="width:100%;list-style-type:none;padding-left:0px;text-align:left;">
							<li class="clusterize-no-data">Loading dataâ€¦</li>
						</ul>
					</div>
					<!--textarea class="form-control" id="resultCoordinates" style="width:100%" rows="15">Coordinates</textarea-->
				</div>
			</div>
		</div>
		<div class="row col-xs-8">
			<div class="col-xs-6">
				<div class="radio">
				<label>
					<input type="radio" name="bottomToTop" id="southToNorthS" value="s" checked>
					South
				</label>
				</div>
				<div class="radio">
				<label>
					<input type="radio" name="bottomToTop" id="southToNorthN" value="n">
					North
				</label>
				</div>
			</div>
			<div class="col-xs-6">
				<div class="radio">
				<label>
					<input type="radio" name="leftToRight" id="westToEastW" value="w" checked>
					West
				</label>
				</div>
				<div class="radio">
				<label>
					<input type="radio" name="leftToRight" id="westToEastE" value="e">
					East
				</label>
				</div>
			</div>
		</div>
		<div class="row col-xs-12">
			<button type="button" class="btn btn-primary" onClick="generateCoordinates();">Generate</button>
		</div>
	</div>
</body>
</html>